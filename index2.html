<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RouteLink — Web App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --accent:#0b5878; --accent-2:#e85a4f; --muted:#6c7a89; --card:#ffffff; --bg:#f3fbff; }
    body{background:linear-gradient(180deg,#f7fbfd,#eef9fb);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;margin:0}
    .brand{color:var(--accent);font-weight:800;font-size:28px}
    .tagline{color:var(--muted);font-style:italic}
    .topbar{padding:14px 18px;background:rgba(255,255,255,0.8);backdrop-filter:blur(4px);border-radius:12px;margin-bottom:18px;display:flex;align-items:center}
    .logobox{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#fff,#f0fbff);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 24px rgba(11,88,120,0.08)}
    .section-card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 10px 30px rgba(13,40,50,0.05)}
    .mini-cal{display:flex;flex-wrap:wrap;gap:6px}
    .cal-day{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #e6eef1}
    .cal-day:hover{transform:translateY(-3px);box-shadow:0 12px 26px rgba(11,88,120,0.08)}
    .cal-today{background:var(--accent);color:#fff;font-weight:700}
    .slot-pill{background:#ecfbf9;color:#0a6b5b;padding:4px 8px;border-radius:999px;font-weight:600}
    .muted-small{color:var(--muted);font-size:0.95rem}
    .hidden{display:none!important}
    .disabled-tab{opacity:0.5;pointer-events:none}
    .topbar-right{margin-left:auto;display:flex;align-items:center;gap:12px}
    @media (max-width:800px){ .topbar{flex-direction:column;gap:10px;align-items:flex-start} .topbar-right{margin-left:0} }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="topbar">
      <div>
        <div class="brand">RouteLink Web</div>
        <div class="tagline">Every Link Counts, Every Route Matters</div>
      </div>

      <!-- logo placed to the right (requested). Using same icon as placeholder for your python code logo -->
      <div class="topbar-right">
        <div id="authArea" class="d-flex align-items-center gap-2">
          <input id="top_email" class="form-control form-control-sm" placeholder="email@vitstudent.ac.in" style="width:220px"/>
          <input id="top_pw" type="password" class="form-control form-control-sm" placeholder="Password" style="width:170px"/>
          <button id="btnLogin" class="btn btn-sm btn-primary">Login</button>
          <button id="btnOpenRegister" class="btn btn-sm btn-outline-primary">Register</button>
        </div>

        <div id="loggedBlock" class="d-flex align-items-center gap-2 hidden">
          <div class="muted-small">Welcome, <strong id="userName"></strong></div>
          <button id="btnLogout" class="btn btn-sm btn-outline-secondary">Logout</button>
        </div>

        <div class="logobox" title="RouteLink">
          <img src="/static/logo.png" alt="logo" width="36" onerror="this.src='https://img.icons8.com/fluency/48/bus.png'"/>
        </div>
      </div>
    </div>

    <!-- placeholder for tabs; intentionally empty until login to prevent any hover/click -->
    <div id="tabsContainer"></div>

    <div class="tab-content">
      <!-- HOME (Login / Register) - always visible -->
      <div class="section-card" id="homeCard">
        <div class="row g-4">
          <div class="col-md-6">
            <h4>Login</h4>
            <p class="muted-small">Use your VIT student email to login.</p>
            <div class="mb-2"><input id="login_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="login_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="d-flex gap-2">
              <button id="doLogin" class="btn btn-primary">Login</button>
              <button id="clearLogin" class="btn btn-outline-secondary">Clear</button>
            </div>
            <div class="mt-2 text-danger small" id="loginMsg"></div>
          </div>

          <div class="col-md-6">
            <h4>Register</h4>
            <p class="muted-small">Register with your VIT student email and select gender.</p>
            <div class="mb-2"><input id="reg_name" class="form-control" placeholder="Full name"></div>
            <div class="mb-2"><input id="reg_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="reg_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="mb-2 d-flex gap-2">
              <select id="reg_gender" class="form-select" style="width:120px"><option value="M">Male</option><option value="F">Female</option></select>
              <button id="doRegister" class="btn btn-outline-primary">Register</button>
            </div>
            <div class="mt-2 text-danger small" id="regMsg"></div>
            <div class="mt-3 muted-small">After register, log in from the left form to access calendar and tools.</div>
          </div>
        </div>
      </div>

      <!-- CALENDAR (added dynamically after login) -->
      <div class="tab-pane fade section-card hidden" id="tab-calendar">
        <div class="row">
          <div class="col-md-4">
            <h5>Calendar</h5>
            <div class="muted-small mb-2">Hover dates to see summary. Past dates cannot be scheduled.</div>
            <div id="miniCalendar" class="mini-cal mb-3"></div>

            <div class="mb-2">
              <label class="form-label small">Selected Date</label>
              <input id="selectedDate" type="date" class="form-control">
            </div>
            <div class="d-flex gap-2">
              <button id="btnAddRoute" class="btn btn-success">➕ Add Route for selected</button>
              <button id="btnRefreshCal" class="btn btn-outline-secondary">Refresh</button>
            </div>
          </div>

          <div class="col-md-8">
            <h5>Routes on <span id="routesDateLabel"></span></h5>
            <div id="routesContainer" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- ROUTE DETAILS modal (will be used instead of an inline table) -->
      <div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Route Details — <span id="modalRouteDate"></span></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="routeModalBody">
              <!-- route table will be injected here (keeps same structure as your previous routesTable) -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ROUTE DETAILS (kept in DOM for backward compatibility - but primary presentation is modal) -->
      <div class="tab-pane fade section-card hidden" id="tab-routes">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Route Details — <span id="routeTabDate"></span></h5>
          <div class="muted-small">Double-click a route to open Link Details for that route.</div>
        </div>
        <div id="routesTable"> <!-- will be filled by JS --> </div>
      </div>

      <!-- LINK DETAILS (added dynamically, hidden until route double-clicked) -->
      <div class="tab-pane fade section-card hidden" id="tab-links">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Link Details for <span id="linksRouteLabel"></span></h5>
          <div>
            <label class="me-2 small">Gender</label>
            <select id="linksGender" class="form-select d-inline-block" style="width:120px"><option>All</option><option>Male</option><option>Female</option></select>
            <button id="btnRefreshLinks" class="btn btn-sm btn-outline-secondary ms-2">Refresh</button>
          </div>
        </div>

        <div id="linksArea">
          <table class="table table-hover">
            <thead class="table-light"><tr><th>Name</th><th>Gender</th><th>Drop</th><th>Phone</th><th>Year</th><th>Branch</th></tr></thead>
            <tbody id="linksTbody"></tbody>
          </table>

          <div class="mt-3">
            <h6>Join this route</h6>
            <div class="row g-2">
              <!-- Name is shown from login and cannot be edited -->
              <div class="col-md-4">
                <label class="form-label small">Name</label>
                <div id="join_name_display" class="form-control-plaintext" style="background:#f6f9fb;border-radius:6px;padding:8px">Not logged in</div>
                <input type="hidden" id="join_name" />
              </div>

              <div class="col-md-2"><label class="form-label small">Gender</label><select id="join_gender" class="form-select"><option value="M">M</option><option value="F">F</option></select></div>
              <div class="col-md-3"><label class="form-label small">Phone</label><input id="join_phone" class="form-control" placeholder="Phone"></div>
              <div class="col-md-3"><label class="form-label small">Year</label><input id="join_year" class="form-control" placeholder="Year"></div>
              <div class="col-md-6 mt-2"><label class="form-label small">Branch</label><input id="join_branch" class="form-control" placeholder="Branch"></div>
              <div class="col-md-6 mt-2"><label class="form-label small">Drop Point</label><input id="join_drop" class="form-control" readonly></div>
              <div class="col-12 mt-2"><button id="btnDoJoin" class="btn btn-primary">Join Route</button> <span id="joinMsg" class="text-danger ms-2"></span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- DELETE LINKS (new tab) -->
      <div class="tab-pane fade section-card hidden" id="tab-delete-links">
        <h5>Manage / Delete Links</h5>
        <p class="muted-small">Below are the links (people) — click delete to remove a specific entry.</p>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light"><tr><th>Name</th><th>Phone</th><th>Drop</th><th>Route Date</th><th>Actions</th></tr></thead>
            <tbody id="deleteLinksTbody"></tbody>
          </table>
        </div>
      </div>

    </div> <!-- tab-content end -->

  </div> <!-- container end -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  /* ----------------- Utilities & state ----------------- */
  const el = id => document.getElementById(id);
  const todayIso = () => new Date().toISOString().slice(0,10);
  let holidays = [];
  let loggedUser = null;
  let currentSelectedDate = todayIso();
  let currentRouteForLinks = null;

  /* ---------- Dynamic tabs insertion to ensure nothing is hoverable/clickable pre-login ---------- */
  function createTabsMarkup(){
    return `
      <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#homeCard" id="tabBtnLogin">Home</button></li>
        <li class="nav-item"><button class="nav-link disabled" id="tabBtnCalendar" data-bs-toggle="tab" data-bs-target="#tab-calendar">Calendar</button></li>
        <li class="nav-item"><button class="nav-link disabled" id="tabBtnRoutes" data-bs-toggle="tab" data-bs-target="#tab-routes">Route Details</button></li>
        <li class="nav-item"><button class="nav-link disabled" id="tabBtnLinks" data-bs-toggle="tab" data-bs-target="#tab-links">Link Details</button></li>
        <li class="nav-item"><button class="nav-link disabled" id="tabBtnDeleteLinks" data-bs-toggle="tab" data-bs-target="#tab-delete-links">Manage Links</button></li>
      </ul>
    `;
  }

  function revealTabsAfterLogin(){
    const container = el('tabsContainer');
    container.innerHTML = createTabsMarkup();
    const calendarBtn = el('tabBtnCalendar');
    const routesBtn = el('tabBtnRoutes');
    const linksBtn = el('tabBtnLinks');
    const deleteBtn = el('tabBtnDeleteLinks');
    // enable calendar and delete-manage links (user should be able to manage their links after login)
    calendarBtn.classList.remove('disabled');
    deleteBtn.classList.remove('disabled');
    routesBtn.classList.add('disabled');
    linksBtn.classList.add('disabled');
    // show calendar tab immediately
    const tab = new bootstrap.Tab(calendarBtn); tab.show();
    // reveal content areas
    el('tab-calendar').classList.remove('hidden');
    el('tab-routes').classList.remove('hidden');
    el('tab-links').classList.remove('hidden');
    el('tab-delete-links').classList.remove('hidden');
    // load deletable links list
    loadDeletableLinks();
  }

  function removeTabs(){
    const container = el('tabsContainer'); container.innerHTML = '';
    el('tab-calendar').classList.add('hidden');
    el('tab-routes').classList.add('hidden');
    el('tab-links').classList.add('hidden');
    el('tab-delete-links').classList.add('hidden');
  }

  /* ---------- Auth (login/register) ---------- */
  async function apiPost(url, data){ return fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(data)}); }

  el('btnOpenRegister').onclick = ()=> { window.scrollTo({top:0, behavior:'smooth'}); };

  // Clear button works: clears login inputs and message
  el('clearLogin').onclick = ()=>{
    el('login_email').value = '';
    el('login_pw').value = '';
    el('loginMsg').textContent = '';
    // also clear top inputs
    el('top_email').value = '';
    el('top_pw').value = '';
  };

  el('doRegister').onclick = async ()=>{
    el('regMsg').textContent = '';
    const name = el('reg_name').value.trim(), email = el('reg_email').value.trim(), pw = el('reg_pw').value, gender = el('reg_gender').value;
    try {
      const res = await apiPost('/register', {name, email, password: pw, gender});
      const json = await res.json();
      if (res.ok){ el('regMsg').style.color='green'; el('regMsg').textContent = 'Registered — please login'; }
      else { el('regMsg').style.color='red'; el('regMsg').textContent = json.error || 'Registration failed'; }
    } catch(e){ el('regMsg').textContent = 'Network error'; }
  };

  el('doLogin').onclick = async ()=>{
    el('loginMsg').textContent='';
    const email = el('login_email').value.trim(), pw = el('login_pw').value;
    try {
      const res = await apiPost('/login', {email, password: pw});
      const json = await res.json();
      if (res.ok){
        loggedUser = {name: json.name};
        el('userName').textContent = json.name || 'User';
        el('authArea').classList.add('hidden');
        el('loggedBlock').classList.remove('hidden');
        // set join name display to logged user
        el('join_name_display').textContent = json.name || '';
        el('join_name').value = json.name || '';
        revealTabsAfterLogin();
        await loadHolidays(); buildMiniCalendar();
        loadRoutesForDate(currentSelectedDate);
      } else {
        el('loginMsg').textContent = json.error || 'Login failed';
      }
    } catch(e){ el('loginMsg').textContent='Network error'; }
  };

  el('btnLogout').onclick = async ()=>{
    await fetch('/logout', {method:'POST'});
    loggedUser = null;
    el('authArea').classList.remove('hidden');
    el('loggedBlock').classList.add('hidden');
    removeTabs();
    const homeTab = document.querySelector('#homeCard'); if (homeTab) { const t = new bootstrap.Tab(homeTab); t.show(); }
    // reset join name display
    el('join_name_display').textContent = 'Not logged in';
    el('join_name').value = '';
  };

  /* ---------- Holidays & Calendar rendering ---------- */
  async function loadHolidays(){ try { const res = await fetch('/holidays'); holidays = await res.json(); } catch(e){ holidays = []; } }
  function isPast(iso){ return new Date(iso) < new Date(new Date().toISOString().slice(0,10)); }

  function buildMiniCalendar(monthOffset=0){
    const base = new Date(); base.setMonth(base.getMonth() + monthOffset);
    const year = base.getFullYear(), month = base.getMonth();
    const first = new Date(year, month, 1);
    const days = new Date(year, month+1, 0).getDate();
    const startWeekday = (first.getDay() + 6) % 7; // Mon=0
    const container = el('miniCalendar'); container.innerHTML = '';
    const hdr = document.createElement('div'); hdr.className='d-flex justify-content-between align-items-center mb-2';
    hdr.innerHTML = `<div><strong>${first.toLocaleString(undefined,{month:'long', year:'numeric'})}</strong></div>
      <div><button id="prevM" class="btn btn-sm btn-outline-secondary me-1">&lt;</button><button id="nextM" class="btn btn-sm btn-outline-secondary">&gt;</button></div>`;
    container.appendChild(hdr);
    const wd = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun']; const wdrow=document.createElement('div'); wdrow.className='d-flex gap-1 mb-2';
    wd.forEach(d=>{ const s=document.createElement('div'); s.style.width='44px'; s.style.textAlign='center'; s.style.color='#7b8a93'; s.textContent=d; wdrow.appendChild(s); });
    container.appendChild(wdrow);
    const grid = document.createElement('div'); grid.className='d-flex flex-wrap gap-2';
    for(let i=0;i<startWeekday;i++){ const blank=document.createElement('div'); blank.style.width='44px'; blank.style.height='44px'; grid.appendChild(blank); }
    for(let day=1; day<=days; day++){
      const iso = new Date(year, month, day).toISOString().slice(0,10);
      const dEl = document.createElement('div'); dEl.className='cal-day'; dEl.textContent = day;
      if (iso === todayIso()) dEl.classList.add('cal-today');
      dEl.onmouseenter = async () => {
        let summ = '';
        try { const r = await fetch('/calendar/' + iso); const js = await r.json(); if (js && js.length) summ = js.map((s,i)=> `${i+1}) ${s.slot_no} → ${s.end_point || '-'} @ ${s.time || '-'}`).join('
'); else if (isPast(iso)) summ = 'Past — cannot schedule'; else summ = 'No routes — click to add'; } catch(e){ summ = 'Unable to load'; }
        dEl.title = summ;
      };
      dEl.onclick = () => {
        if (isPast(iso)){ alert('This date has passed. Scheduling disabled.'); return; }
        currentSelectedDate = iso; el('selectedDate').value = iso; el('routesDateLabel').textContent = iso;
        const routesBtn = document.getElementById('tabBtnRoutes'); if (routesBtn) routesBtn.classList.remove('disabled');
        // show routes section in modal rather than inline table
        loadRoutesForDate(iso).then(()=> {
          const tbl = el('routesTable')?.innerHTML || '<div class="muted-small">No routes</div>';
          el('routeModalBody').innerHTML = tbl;
          el('modalRouteDate').textContent = iso;
          const routeModal = new bootstrap.Modal(document.getElementById('routeModal'));
          routeModal.show();
        });
      };
      grid.appendChild(dEl);
    }
    container.appendChild(grid);
    el('prevM').onclick = ()=> buildMiniCalendar(monthOffset-1);
    el('nextM').onclick = ()=> buildMiniCalendar(monthOffset+1);
  }

  /* ---------- Routes list & create ---------- */
  async function loadRoutesForDate(iso){
    el('routesDateLabel').textContent = iso; el('routeTabDate').textContent = iso;
    try {
      const res = await fetch('/calendar/' + iso);
      const js = await res.json();
      const container = el('routesContainer'); container.innerHTML = '';
      if (!js || js.length===0) container.innerHTML = '<div class="muted-small">No routes yet. Click Add Route to create one.</div>';
      js.forEach(route=>{
        const card = document.createElement('div'); card.className='d-flex justify-content-between align-items-center p-3 mb-2 border rounded';
        const left = document.createElement('div'); left.innerHTML = `<div><span class="slot-pill">${route.slot_no}</span> <strong class="ms-2">${route.end_point || ''}</strong></div><div class="muted-small">${route.major_stops || ''}</div>`;
        const right = document.createElement('div'); right.innerHTML = `<div>${route.time || '-'}</div><div class="mt-2"><button class="btn btn-sm btn-primary me-2" onclick="openLinksForRoute(${route.id})">View Links</button><button class="btn btn-sm btn-outline-secondary" onclick="prefillJoin(${route.id}, '${(route.end_point||'').replace(/'/g,"\'")}')">Join</button></div>`;
        card.appendChild(left); card.appendChild(right);
        card.ondblclick = ()=> {
          const linksBtn = document.getElementById('tabBtnLinks'); if (linksBtn) linksBtn.classList.remove('disabled');
          openLinksForRoute(route.id);
        };
        container.appendChild(card);
      });

      // populate simple route table in Route Details area (kept for compatibility)
      buildRouteTable(js);
    } catch(e){ console.error(e); }
  }

  function buildRouteTable(routes){
    const wrapper = el('routesTable'); wrapper.innerHTML = '';
    const table = document.createElement('table'); table.className = 'table';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Slot</th><th>End Point</th><th>Major Stops</th><th>Time</th><th>Actions</th></tr>';
    table.appendChild(thead);
    const tb = document.createElement('tbody');
    routes.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.slot_no}</td><td>${r.end_point || ''}</td><td>${r.major_stops || ''}</td><td>${r.time || '-'}</td>
        <td><button class="btn btn-sm btn-primary me-1" onclick="openLinksForRoute(${r.id})">Links</button><button class="btn btn-sm btn-success" onclick="prefillJoin(${r.id}, '${(r.end_point||'').replace(/'/g,"\'")}')">Join</button></td>`;
      tb.appendChild(tr);
    });
    table.appendChild(tb); wrapper.appendChild(table);
  }

  el('btnAddRoute')?.addEventListener('click', async ()=>{
    const date = el('selectedDate').value || currentSelectedDate;
    if (!date) { alert('Pick a date'); return; }
    if (new Date(date) < new Date(todayIso())){ alert('Cannot add route to past date'); return; }
    let slot='SL0000';
    try{ const r = await fetch('/next_slot'); const j = await r.json(); slot = j.slot || slot; }catch(e){}
    const end = prompt('Enter endpoint for the route (e.g., Main Gate):', '');
    if (!end) return;
    const stops = prompt('Major stops (comma separated):', '');
    const time = prompt('Time (HH:MM) — optional:', '');
    const transport = prompt('Transport type (bus/car):', '');
    try {
      const res = await fetch('/routes', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date, slot_no:slot, end_point:end, major_stops:stops, time, transport_type:transport})});
      if (res.status===201){ alert('Route added'); loadRoutesForDate(date); }
      else { const txt = await res.text(); alert('Error: ' + txt); }
    } catch(e){ alert('Network error'); }
  });

  /* ---------- Link details (open when route selected) ---------- */
  function prefillJoin(routeId, endPoint){ openLinksForRoute(routeId, endPoint); const btn = document.getElementById('tabBtnLinks'); if (btn) { btn.classList.remove('disabled'); const t = new bootstrap.Tab(btn); t.show(); } }

  async function openLinksForRoute(routeId, endPointFromArg){
    currentRouteForLinks = null;
    try {
      const r = await fetch('/calendar/' + currentSelectedDate);
      const rows = await r.json();
      const route = rows.find(x => x.id === routeId);
      if (!route){ alert('Route not found'); return; }
      currentRouteForLinks = route;
      el('linksRouteLabel').textContent = route.slot_no + ' → ' + (route.end_point || '-');
      el('join_drop').value = route.end_point || (endPointFromArg || '');
      const linksBtn = document.getElementById('tabBtnLinks'); if (linksBtn) linksBtn.classList.remove('disabled');
      const t = linksBtn ? new bootstrap.Tab(linksBtn) : null; if (t) t.show();
      const resLinks = await fetch(`/routes/${routeId}/links?date=${encodeURIComponent(currentSelectedDate)}`);
      const people = await resLinks.json();
      const tbody = el('linksTbody'); tbody.innerHTML = '';
      if (!people || people.length===0) tbody.innerHTML = '<tr><td colspan="6" class="muted-small">No one has joined this route yet.</td></tr>';
      else { for (const p of people){ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.name}</td><td>${(p.gender||'')}</td><td>${(p.drop_point||'')}</td><td>${(p.phone||'')}</td><td>${(p.course_year||'')}</td><td>${(p.branch||'')}</td>`; tbody.appendChild(tr); } }
    } catch(e){ console.error(e); alert('Unable to fetch links'); }
  }

  el('btnDoJoin')?.addEventListener('click', async ()=>{
    if (!currentRouteForLinks){ alert('No route selected'); return; }
    const routeId = currentRouteForLinks.id;
    const payload = {
      date: currentSelectedDate,
      name: el('join_name').value || el('join_name_display').textContent,
      gender: el('join_gender').value,
      drop: el('join_drop').value,
      phone: el('join_phone').value.trim(),
      course_year: el('join_year').value.trim(),
      branch: el('join_branch').value.trim()
    };
    el('joinMsg').textContent = '';
    try {
      const res = await fetch(`/routes/${routeId}/join`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      if (res.status === 201){ el('joinMsg').style.color='green'; el('joinMsg').textContent='Joined'; openLinksForRoute(routeId); loadRoutesForDate(currentSelectedDate); loadDeletableLinks(); }
      else { const txt = await res.text(); el('joinMsg').style.color='red'; el('joinMsg').textContent = txt; }
    } catch(e){ el('joinMsg').style.color='red'; el('joinMsg').textContent = 'Network error'; }
  });

  /* ---------- Manage / Delete Links ---------- */
  async function loadDeletableLinks(){
    try {
      const res = await fetch('/links');
      const list = await res.json();
      const tbody = el('deleteLinksTbody'); tbody.innerHTML = '';
      if (!list || list.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="muted-small">No links</td></tr>';
      else {
        for (const p of list){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.name || ''}</td><td>${p.phone || ''}</td><td>${p.drop_point || ''}</td><td>${p.course_year || ''}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteLink(${p.id})">Delete</button></td>`;
          tbody.appendChild(tr);
        }
      }
    } catch(e){ console.error(e); }
  }

  async function deleteLink(lid){
    if (!confirm('Delete this link? This cannot be undone.')) return;
    try {
      const res = await fetch(`/links/${lid}`, {method:'DELETE'});
      if (res.ok){ alert('Deleted'); loadDeletableLinks(); if (currentRouteForLinks) openLinksForRoute(currentRouteForLinks.id); }
      else { const txt = await res.text(); alert('Error: ' + txt); }
    } catch(e){ alert('Network error'); }
  }

  el('btnRefreshLinks')?.addEventListener('click', ()=> { if (currentRouteForLinks) openLinksForRoute(currentRouteForLinks.id); else loadAllLinks(); });
  el('linksGender')?.addEventListener('change', ()=> { if (currentRouteForLinks) openLinksForRoute(currentRouteForLinks.id); else loadAllLinks(); });

  async function loadAllLinks(){ try { const gender = el('linksGender').value; const param = (gender === 'All') ? '' : '?gender='+ (gender[0].toUpperCase()); const res = await fetch('/links' + param); const list = await res.json(); const tbody = el('linksTbody'); tbody.innerHTML = ''; if (!list || list.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="muted-small">No links</td></tr>'; else { for (const p of list){ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.name}</td><td>${p.gender||''}</td><td>${p.drop_point||''}</td><td>${p.phone||''}</td><td>${p.course_year||''}</td><td>${p.branch||''}</td>`; tbody.appendChild(tr); } } } catch(e){ console.error(e); } }

  /* ---------- Startup ---------- */
  (async function init(){ try { buildMiniCalendar(); el('selectedDate').value = currentSelectedDate; el('routesDateLabel').textContent = currentSelectedDate; const me = await fetch('/me'); const j = await me.json(); if (j && j.id){ loggedUser={name:j.name}; el('userName').textContent = j.name; el('authArea').classList.add('hidden'); el('loggedBlock').classList.remove('hidden'); el('join_name_display').textContent = j.name || ''; el('join_name').value = j.name || ''; revealTabsAfterLogin(); loadRoutesForDate(currentSelectedDate); } } catch(e){ console.error(e); } })();
  </script>
</body>
</html>
