<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RouteLink — Web App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --accent:#0b5878; --muted:#6c7a89; --card:#fff; --bg:#f3fbff; }
    body{background:var(--bg);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;margin:0}
    .brand{color:var(--accent);font-weight:800;font-size:28px}
    .tagline{color:var(--muted);font-style:italic}
    .topbar{padding:14px 18px;background:linear-gradient(90deg,#f6fbfd,#eef9fb);border-radius:12px;margin-bottom:18px;display:flex;align-items:center}
    .logobox{width:64px;height:64px;border-radius:10px;background:linear-gradient(180deg,#fff,#f0fbff);display:flex;align-items:center;justify-content:center}
    .section-card{background:var(--card);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 6px 18px rgba(13,40,50,0.04)}
    .mini-cal{display:flex;flex-wrap:wrap;gap:6px}
    .cal-day{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid #e6eef1}
    .cal-day:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(11,88,120,0.06)}
    .cal-today{background:var(--accent);color:#fff;font-weight:700}
    .slot-pill{background:#ecfbf9;color:#0a6b5b;padding:4px 8px;border-radius:999px;font-weight:600}
    .muted-small{color:var(--muted);font-size:0.95rem}
    .hidden{display:none!important}
    .nav-locked .nav-link{opacity:0.5;pointer-events:none}
    .offcanvas-end{width:420px;max-width:95%}
    .modal-lg .modal-body table td { vertical-align: middle; }
    @media (max-width:800px){ .topbar{flex-direction:column;gap:10px;align-items:flex-start} .offcanvas-end{width:100%} }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="topbar">
      <div class="d-flex align-items-center gap-3">
        <div class="logobox"><img src="/static/logo.png" width="48" alt="logo" onerror="this.src='https://img.icons8.com/fluency/48/bus.png'"/></div>
        <div>
          <div class="brand">RouteLink Web</div>
          <div class="tagline">Every Link Counts, Every Route Matters</div>
        </div>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2" id="authArea">
        <input id="top_email" class="form-control form-control-sm" placeholder="email@vitstudent.ac.in" style="width:220px"/>
        <input id="top_pw" type="password" class="form-control form-control-sm" placeholder="Password" style="width:170px"/>
        <button id="btnTopLogin" class="btn btn-sm btn-primary">Login</button>
        <button id="btnOpenRegister" class="btn btn-sm btn-outline-primary">Register</button>

        <div id="loggedBlock" class="d-flex align-items-center gap-2 hidden">
          <div class="muted-small">Welcome, <strong id="userName"></strong></div>
          <button id="btnLogout" class="btn btn-sm btn-outline-secondary">Logout</button>
        </div>
      </div>
    </div>

    <!-- nav locked initially -->
    <ul class="nav nav-tabs mb-3 nav-locked" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-login" id="tabBtnLogin">Home</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnCalendar" data-bs-toggle="tab" data-bs-target="#tab-calendar">Calendar</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnRoutes" data-bs-toggle="tab" data-bs-target="#tab-routes">Route Details</button></li>
      <li class="nav-item"><button class="nav-link disabled" id="tabBtnLinks" data-bs-toggle="tab" data-bs-target="#tab-links">Link Details</button></li>
    </ul>

    <div class="tab-content">
      <!-- HOME (login/register) -->
      <div class="tab-pane fade show active section-card" id="tab-login">
        <div class="row g-4">
          <div class="col-md-6">
            <h4>Login</h4>
            <p class="muted-small">Use your VIT student email to login.</p>
            <div class="mb-2"><input id="login_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="login_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="d-flex gap-2">
              <button id="doLogin" class="btn btn-primary">Login</button>
              <button id="clearLogin" class="btn btn-outline-secondary">Clear</button>
            </div>
            <div class="mt-2 text-danger small" id="loginMsg"></div>
          </div>

          <div class="col-md-6">
            <h4>Register</h4>
            <p class="muted-small">Register with your VIT student email and select gender.</p>
            <div class="mb-2"><input id="reg_name" class="form-control" placeholder="Full name"></div>
            <div class="mb-2"><input id="reg_email" class="form-control" placeholder="email@vitstudent.ac.in"></div>
            <div class="mb-2"><input id="reg_pw" type="password" class="form-control" placeholder="Password"></div>
            <div class="mb-2 d-flex gap-2">
              <select id="reg_gender" class="form-select" style="width:120px"><option value="M">Male</option><option value="F">Female</option></select>
              <button id="doRegister" class="btn btn-outline-primary">Register</button>
            </div>
            <div class="mt-2 text-danger small" id="regMsg"></div>
            <div class="mt-3 muted-small">After register, log in from the left form to access calendar and tools.</div>
          </div>
        </div>
      </div>

      <!-- CALENDAR (enabled post-login) -->
      <div class="tab-pane fade section-card hidden" id="tab-calendar">
        <div class="row">
          <div class="col-md-4">
            <h5>Calendar</h5>
            <div class="muted-small mb-2">Hover dates to see summary. Past dates cannot be scheduled.</div>
            <div id="miniCalendar" class="mini-cal mb-3"></div>

            <div class="mb-2">
              <label class="form-label small">Selected Date</label>
              <input id="selectedDate" type="date" class="form-control">
            </div>
            <div class="d-flex gap-2">
              <button id="btnAddRoute" class="btn btn-success">➕ Add Route for selected</button>
              <button id="btnRefreshCal" class="btn btn-outline-secondary">Refresh</button>
            </div>
          </div>

          <div class="col-md-8">
            <h5>Routes on <span id="routesDateLabel"></span></h5>
            <div id="routesContainer" class="mt-3"></div>
          </div>
        </div>
      </div>

      <!-- ROUTE DETAILS (kept but content shown in offcanvas) -->
      <div class="tab-pane fade section-card hidden" id="tab-routes">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Route Details — <span id="routeTabDate"></span></h5>
          <div class="muted-small">Double-click a route to open Link Details for that route.</div>
        </div>
        <div id="routesTable"></div>
      </div>

      <!-- LINKS -->
      <div class="tab-pane fade section-card hidden" id="tab-links">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Link Details for <span id="linksRouteLabel"></span></h5>
          <div>
            <label class="me-2 small">Gender</label>
            <select id="linksGender" class="form-select d-inline-block" style="width:120px"><option>All</option><option>Male</option><option>Female</option></select>
            <button id="btnRefreshLinks" class="btn btn-sm btn-outline-secondary ms-2">Refresh</button>
          </div>
        </div>
        <div id="linksArea">
          <table class="table table-hover">
            <thead class="table-light"><tr><th>Name</th><th>Gender</th><th>Drop</th><th>Phone</th><th>Year</th><th>Branch</th></tr></thead>
            <tbody id="linksTbody"></tbody>
          </table>
          <!-- Join remains only in offcanvas -->
        </div>
      </div>
    </div>
  </div>

  <!-- Add Route Modal (table-like attractive form) -->
  <div class="modal fade" id="modalAddRoute" tabindex="-1" aria-labelledby="modalAddRouteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAddRouteLabel">Add Route — <small id="modalRouteDate"></small></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-borderless">
            <tbody>
              <tr>
                <td style="width:160px"><label class="form-label">Slot No</label></td>
                <td><input id="modal_slot" class="form-control" readonly></td>
              </tr>
              <tr>
                <td><label class="form-label">End Point</label></td>
                <td><input id="modal_endpoint" class="form-control" placeholder="e.g., Main Gate"></td>
              </tr>
              <tr>
                <td><label class="form-label">Major Stops</label></td>
                <td><input id="modal_stops" class="form-control" placeholder="Comma separated"></td>
              </tr>
              <tr>
                <td><label class="form-label">Time (HH:MM)</label></td>
                <td><input id="modal_time" class="form-control" placeholder="09:30"></td>
              </tr>
              <tr>
                <td><label class="form-label">Transport Type</label></td>
                <td>
                  <select id="modal_transport" class="form-select" style="width:160px">
                    <option value="">(select)</option><option value="bus">Bus</option><option value="car">Car</option>
                  </select>
                </td>
              </tr>
            </tbody>
          </table>
          <div id="modalAddRouteMsg" class="text-danger small"></div>
        </div>
        <div class="modal-footer">
          <button id="modalAddRouteCancel" type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="modalAddRouteSubmit" type="button" class="btn btn-success">Create Route</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas panels for Route & Links (Link offcanvas contains Join form) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRoute" aria-labelledby="offcanvasRouteLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasRouteLabel">Route Details — <small id="offcanvasRouteDate"></small></h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body"><div id="offRouteContent"></div></div>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasLinks" aria-labelledby="offcanvasLinksLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasLinksLabel">Link Details — <small id="offcanvasLinksDate"></small></h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="offLinksContent"></div>
      <hr/>
      <h6>Join this route</h6>
      <div class="mb-2">
        <label class="form-label small">Name</label>
        <input id="off_join_name" class="form-control" readonly>
      </div>
      <div class="row g-2">
        <div class="col-md-4"><label class="form-label small">Phone</label><input id="off_join_phone" class="form-control" placeholder="Phone"></div>
        <div class="col-md-4"><label class="form-label small">Year</label><input id="off_join_year" class="form-control" placeholder="Year"></div>
        <div class="col-md-4"><label class="form-label small">Branch</label><input id="off_join_branch" class="form-control" placeholder="Branch"></div>
      </div>
      <div class="mt-2"><label class="form-label small">Drop point</label><input id="off_join_drop" class="form-control" readonly></div>
      <div class="mt-3"><button id="off_btnDoJoin" class="btn btn-primary">Join</button> <span id="off_joinMsg" class="text-danger ms-2"></span></div>
    </div>
  </div>

  <!-- bootstrap bundle first -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* Utilities */
  const el = id => document.getElementById(id);

  /* local-date ISO (browser local) */
  const todayIso = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };

  let loggedUser = null;
  let currentSelectedDate = todayIso();
  let currentRouteForLinks = null;

  /* fetch wrapper that sends credentials */
  function fetchWithCreds(url, opts = {}) {
    opts.credentials = opts.credentials || 'same-origin';
    return fetch(url, opts);
  }

  /* POST JSON helper */
  async function postJson(url, data){
    return fetchWithCreds(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
  }

  /* ---------- DOM ready ---------- */
  document.addEventListener('DOMContentLoaded', ()=>{

    // Wire login handlers
    async function handleLogin(){
      el('loginMsg').textContent = '';
      const email = (el('login_email')?.value || el('top_email')?.value || '').trim();
      const pw = (el('login_pw')?.value || el('top_pw')?.value || '');
      if (!email || !pw){ el('loginMsg').textContent='Email and password required'; return; }
      try {
        const res = await postJson('/login', { email, password: pw });
        const body = await (res.json().catch(()=>({})));
        if (res.ok) {
          loggedUser = { name: body.name || '', email };
          el('userName').textContent = body.name || email;
          el('authArea').classList.add('hidden');
          el('loggedBlock').classList.remove('hidden');
          // prefill join name readonly
          if (el('off_join_name')) { el('off_join_name').value = loggedUser.name; el('off_join_name').readOnly = true; }
          // enable only Calendar and show it
          el('tabBtnCalendar').classList.remove('disabled');
          document.querySelector('#mainTabs').classList.remove('nav-locked');
          el('tab-calendar').classList.remove('hidden');
          new bootstrap.Tab(el('tabBtnCalendar')).show();
          // refresh calendar and routes
          await loadHolidays();
          buildMiniCalendar();
          loadRoutesForDate(currentSelectedDate);
        } else {
          const err = body && body.error ? body.error : `Login failed (${res.status})`;
          el('loginMsg').textContent = err;
          console.error('Login failed', res.status, body);
        }
      } catch (e) {
        console.error('Login network', e);
        el('loginMsg').textContent = 'Network error — make sure server is running and you opened the app via http://127.0.0.1:5000';
      }
    }

    el('doLogin')?.addEventListener('click', handleLogin);
    el('btnTopLogin')?.addEventListener('click', handleLogin);

    el('clearLogin')?.addEventListener('click', ()=> {
      if (el('login_email')) el('login_email').value=''; if (el('login_pw')) el('login_pw').value=''; if (el('top_email')) el('top_email').value=''; if (el('top_pw')) el('top_pw').value=''; el('loginMsg').textContent='';
    });

    // Register
    el('doRegister')?.addEventListener('click', async ()=>{
      el('regMsg').textContent = '';
      const name = el('reg_name')?.value.trim() || '', email = el('reg_email')?.value.trim() || '', pw = el('reg_pw')?.value || '', gender = el('reg_gender')?.value || 'M';
      if (!name || !email || !pw){ el('regMsg').textContent = 'All fields required'; return; }
      try {
        const res = await postJson('/register', { name, email, password: pw, gender });
        const body = await (res.json().catch(()=>({})));
        if (res.ok) { el('regMsg').style.color='green'; el('regMsg').textContent='Registered — please login'; }
        else { el('regMsg').style.color='red'; el('regMsg').textContent = body.error || `Register failed (${res.status})`; }
      } catch(e){ console.error('register', e); el('regMsg').textContent = 'Network error'; }
    });

    // Logout
    el('btnLogout')?.addEventListener('click', async ()=>{
      try { await fetchWithCreds('/logout', { method:'POST' }); } catch(e){ console.warn('logout', e); }
      loggedUser = null;
      el('authArea').classList.remove('hidden');
      el('loggedBlock').classList.add('hidden');
      document.querySelector('#mainTabs').classList.add('nav-locked');
      el('tabBtnCalendar').classList.add('disabled');
      el('tabBtnRoutes').classList.add('disabled');
      el('tabBtnLinks').classList.add('disabled');
      if (el('off_join_name')) { el('off_join_name').value=''; el('off_join_name').readOnly=false; }
      new bootstrap.Tab(el('tabBtnLogin')).show();
    });

    /* Add Route modal workflow */
    const modalAddRouteEl = document.getElementById('modalAddRoute');
    const modalAddRoute = new bootstrap.Modal(modalAddRouteEl);
    el('btnAddRoute')?.addEventListener('click', async ()=>{
      // ensure only available after login
      if (!el('tabBtnCalendar') || el('tabBtnCalendar').classList.contains('disabled')) {
        alert('Login required to add a route');
        return;
      }
      // fill slot and date
      el('modalRouteDate').textContent = currentSelectedDate;
      el('modal_slot').value = 'SL0000';
      try {
        const r = await fetchWithCreds('/next_slot'); const j = await r.json();
        el('modal_slot').value = j.slot || 'SL0000';
      } catch(e){ el('modal_slot').value = 'SL0000'; }
      el('modal_endpoint').value = '';
      el('modal_stops').value = '';
      el('modal_time').value = '';
      el('modal_transport').value = '';
      el('modalAddRouteMsg').textContent = '';
      modalAddRoute.show();
    });

    el('modalAddRouteSubmit')?.addEventListener('click', async ()=>{
      const date = currentSelectedDate;
      const slot = el('modal_slot').value.trim();
      const endp = el('modal_endpoint').value.trim();
      const stops = el('modal_stops').value.trim();
      const time = el('modal_time').value.trim();
      const transport = el('modal_transport').value.trim();
      if (!date || !slot || !endp) { el('modalAddRouteMsg').textContent = 'Date, Slot and End Point are required'; return; }
      // basic time validation if provided
      if (time && !/^\d{2}:\d{2}$/.test(time)) { el('modalAddRouteMsg').textContent = 'Time must be HH:MM'; return; }
      try {
        const res = await fetchWithCreds('/routes', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ date, slot_no: slot, end_point: endp, major_stops: stops, time, transport_type: transport })
        });
        if (res.status === 201) {
          modalAddRoute.hide();
          await loadRoutesForDate(date);
        } else {
          const txt = await res.text();
          el('modalAddRouteMsg').textContent = txt || `Error (${res.status})`;
        }
      } catch(e){ console.error('add route', e); el('modalAddRouteMsg').textContent = 'Network error'; }
    });

    /* offcanvas join in Link details */
    el('off_btnDoJoin')?.addEventListener('click', async ()=>{
      if (!currentRouteForLinks) { alert('Select a route first'); return; }
      const payload = {
        date: currentSelectedDate,
        name: el('off_join_name')?.value || '',
        gender: 'M',
        drop: el('off_join_drop')?.value || '',
        phone: el('off_join_phone')?.value || '',
        course_year: el('off_join_year')?.value || '',
        branch: el('off_join_branch')?.value || ''
      };
      el('off_joinMsg').textContent = '';
      try {
        const r = await fetchWithCreds(`/routes/${currentRouteForLinks.id}/join`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (r.status === 201) { el('off_joinMsg').style.color='green'; el('off_joinMsg').textContent='Joined'; openLinksPanel(currentRouteForLinks.id); loadRoutesForDate(currentSelectedDate); }
        else { const txt = await r.text(); el('off_joinMsg').style.color='red'; el('off_joinMsg').textContent = txt; }
      } catch(e){ console.error('join', e); el('off_joinMsg').style.color='red'; el('off_joinMsg').textContent = 'Network error'; }
    });

    // refresh calendar
    el('btnRefreshCal')?.addEventListener('click', ()=> buildMiniCalendar());
    el('btnRefreshLinks')?.addEventListener('click', ()=> { if (currentRouteForLinks) openLinksPanel(currentRouteForLinks.id); else loadAllLinks(); });
    el('linksGender')?.addEventListener('change', ()=> { if (currentRouteForLinks) openLinksPanel(currentRouteForLinks.id); else loadAllLinks(); });

  }); // DOMContentLoaded end

  /* ---------- Holidays & Calendar rendering ---------- */
  async function loadHolidays(){
    try { const r = await fetchWithCreds('/holidays'); window.__hols = await r.json(); } catch(e){ window.__hols = []; }
  }

  function isPast(iso){ return new Date(iso) < new Date(todayIso()); }

  function buildMiniCalendar(monthOffset=0){
    const base = new Date(); base.setMonth(base.getMonth() + monthOffset);
    const year = base.getFullYear(), month = base.getMonth();
    const first = new Date(year, month, 1);
    const days = new Date(year, month+1, 0).getDate();
    const startWeekday = (first.getDay() + 6) % 7;
    const container = el('miniCalendar'); if (!container) return;
    container.innerHTML = '';
    const hdr = document.createElement('div'); hdr.className='d-flex justify-content-between align-items-center mb-2';
    hdr.innerHTML = `<div><strong>${first.toLocaleString(undefined,{month:'long', year:'numeric'})}</strong></div>
      <div><button id="prevM" class="btn btn-sm btn-outline-secondary me-1">&lt;</button><button id="nextM" class="btn btn-sm btn-outline-secondary">&gt;</button></div>`;
    container.appendChild(hdr);
    const wd = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const wdrow = document.createElement('div'); wdrow.className='d-flex gap-1 mb-2';
    wd.forEach(d=>{ const s=document.createElement('div'); s.style.width='44px'; s.style.textAlign='center'; s.style.color='#7b8a93'; s.textContent=d; wdrow.appendChild(s); });
    container.appendChild(wdrow);
    const grid = document.createElement('div'); grid.className='d-flex flex-wrap gap-2';
    for(let i=0;i<startWeekday;i++){ const blank=document.createElement('div'); blank.style.width='44px'; blank.style.height='44px'; grid.appendChild(blank); }
    for(let day=1; day<=days; day++){
      // build iso for that local day
      const iso = new Date(year, month, day).toISOString().slice(0,10);
      const dEl = document.createElement('div'); dEl.className='cal-day'; dEl.textContent = day;
      if (iso === todayIso()) dEl.classList.add('cal-today'); // local today highlight
      dEl.onmouseenter = async () => {
        let summ = '';
        try { const r = await fetchWithCreds('/calendar/' + iso); const js = await r.json(); if (js && js.length) summ = js.map((s,i)=> `${i+1}) ${s.slot_no} → ${s.end_point || '-'} @ ${s.time || '-'}`).join('\n'); else if ((window.__hols||[]).includes(iso)) summ = 'Holiday'; else if (isPast(iso)) summ = 'Past — cannot schedule'; else summ = 'No routes — click to add'; } catch(e){ summ = 'Unable to load'; }
        dEl.title = summ;
      };
      dEl.onclick = () => {
        if (isPast(iso)){ alert('This date has passed. Scheduling disabled.'); return; }
        currentSelectedDate = iso; if (el('selectedDate')) el('selectedDate').value = iso; if (el('routesDateLabel')) el('routesDateLabel').textContent = iso;
        // enable Route Details tab and show it
        el('tabBtnRoutes').classList.remove('disabled');
        new bootstrap.Tab(el('tabBtnRoutes')).show();
        loadRoutesForDate(iso);
      };
      grid.appendChild(dEl);
    }
    container.appendChild(grid);
    el('prevM').onclick = ()=> buildMiniCalendar(monthOffset-1);
    el('nextM').onclick = ()=> buildMiniCalendar(monthOffset+1);
  }

  /* ---------- Routes list & create ---------- */
  async function loadRoutesForDate(iso){
    if (el('routesDateLabel')) el('routesDateLabel').textContent = iso;
    if (el('routeTabDate')) el('routeTabDate').textContent = iso;
    try {
      const res = await fetchWithCreds('/calendar/' + iso);
      const js = await res.json();
      const container = el('routesContainer'); if (!container) return; container.innerHTML = '';
      if (!js || js.length===0) container.innerHTML = '<div class="muted-small">No routes yet. Click Add Route to create one.</div>';
      else {
        js.forEach(route=>{
          const card = document.createElement('div'); card.className='d-flex justify-content-between align-items-center p-3 mb-2 border rounded';
          const left = document.createElement('div'); left.innerHTML = `<div><span class="slot-pill">${route.slot_no}</span> <strong class="ms-2">${route.end_point || ''}</strong></div><div class="muted-small">${route.major_stops || ''}</div>`;
          const right = document.createElement('div'); right.innerHTML = `<div>${route.time || '-'}</div><div class="mt-2"><button class="btn btn-sm btn-primary me-2" onclick="openRoutePanel(${route.id})">View</button></div>`;
          card.appendChild(left); card.appendChild(right);
          card.ondblclick = ()=> { el('tabBtnLinks').classList.remove('disabled'); openLinksPanel(route.id); };
          container.appendChild(card);
        });
      }
      // build route table (no join buttons here)
      buildRouteTable(js);
      el('tabBtnRoutes').classList.remove('disabled');
    } catch(e){ console.error(e); }
  }

  function buildRouteTable(routes){
    const wrapper = el('routesTable'); if (!wrapper) return;
    wrapper.innerHTML = '';
    const table = document.createElement('table'); table.className='table';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Slot</th><th>End Point</th><th>Major Stops</th><th>Time</th><th>Actions</th></tr>';
    table.appendChild(thead);
    const tb = document.createElement('tbody');
    (routes||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.slot_no}</td><td>${r.end_point || ''}</td><td>${r.major_stops || ''}</td><td>${r.time || '-'}</td>
        <td><button class="btn btn-sm btn-primary me-1" onclick="openRoutePanel(${r.id})">View</button></td>`;
      tb.appendChild(tr);
    });
    table.appendChild(tb); wrapper.appendChild(table);
  }

  /* ---------- Offcanvas Route & Links ---------- */
  function renderRouteHTML(route){
    return `<div>
      <p><strong>Slot:</strong> ${route.slot_no}</p>
      <p><strong>End Point:</strong> ${route.end_point || '-'}</p>
      <p><strong>Major Stops:</strong> ${route.major_stops || '-'}</p>
      <p><strong>Time:</strong> ${route.time || '-'}</p>
      <p><strong>Transport:</strong> ${route.transport_type || '-'}</p>
    </div>`;
  }

  async function openRoutePanel(routeId){
    try {
      const r = await fetchWithCreds('/calendar/' + currentSelectedDate);
      const rows = await r.json();
      const route = rows.find(x => x.id === routeId);
      if (!route){ alert('Route not found'); return; }
      el('offcanvasRouteDate').textContent = currentSelectedDate;
      el('offRouteContent').innerHTML = renderRouteHTML(route) + `<div class="mt-3"><button class="btn btn-sm btn-primary" onclick="openLinksPanel(${route.id})">Open Links</button></div>`;
      const oc = new bootstrap.Offcanvas(document.getElementById('offcanvasRoute'));
      oc.show();
    } catch(e){ console.error('openRoutePanel', e); alert('Unable to fetch route'); }
  }

  async function openLinksPanel(routeId){
    currentRouteForLinks = null;
    try {
      const r = await fetchWithCreds('/calendar/' + currentSelectedDate);
      const rows = await r.json();
      const route = rows.find(x => x.id === routeId);
      if (!route){ alert('Route not found'); return; }
      currentRouteForLinks = route;
      el('offcanvasLinksDate').textContent = currentSelectedDate;
      el('offLinksContent').innerHTML = `<p><strong>${route.slot_no} → ${route.end_point || '-'}</strong></p><div id="offLinksList"></div>`;
      const resLinks = await fetchWithCreds(`/routes/${routeId}/links?date=${encodeURIComponent(currentSelectedDate)}`);
      const people = await resLinks.json();
      const listEl = document.getElementById('offLinksList');
      if (!people || people.length===0) listEl.innerHTML = '<div class="muted-small">No one has joined this route yet.</div>';
      else {
        listEl.innerHTML = '<ul class="list-group"></ul>';
        const ul = listEl.querySelector('ul');
        people.forEach(p => {
          const li = document.createElement('li'); li.className = 'list-group-item';
          li.innerHTML = `<div><strong>${p.name}</strong> <small class="text-muted">(${p.course_year || ''} - ${p.branch || ''})</small></div><div>${p.drop_point || ''} • ${p.phone || ''}</div>`;
          ul.appendChild(li);
        });
      }
      // prefill join drop and name
      if (el('off_join_drop')) el('off_join_drop').value = route.end_point || '';
      if (el('off_join_name') && loggedUser) { el('off_join_name').value = loggedUser.name || ''; el('off_join_name').readOnly = true; }
      const oc = new bootstrap.Offcanvas(document.getElementById('offcanvasLinks'));
      oc.show();
      // enable Links tab now that route is opened
      el('tabBtnLinks').classList.remove('disabled');
    } catch(e){ console.error('openLinksPanel', e); alert('Unable to fetch links'); }
  }

  async function loadAllLinks(){
    try {
      const gender = el('linksGender')?.value || 'All';
      const param = (gender === 'All') ? '' : '?gender=' + (gender[0].toUpperCase());
      const r = await fetchWithCreds('/links' + param);
      const list = await r.json();
      const tbody = el('linksTbody'); if (!tbody) return; tbody.innerHTML = '';
      if (!list || list.length === 0) tbody.innerHTML = '<tr><td colspan="6" class="muted-small">No links</td></tr>';
      else {
        for (const p of list){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.name}</td><td>${p.gender||''}</td><td>${p.drop_point||''}</td><td>${p.phone||''}</td><td>${p.course_year||''}</td><td>${p.branch||''}</td>`;
          tbody.appendChild(tr);
        }
      }
    } catch(e){ console.error('loadAllLinks', e); }
  }

  /* ---------- Startup: check /me ---------- */
  (async function init(){
    try {
      await loadHolidays();
      buildMiniCalendar();
      if (el('selectedDate')) el('selectedDate').value = currentSelectedDate;
      if (el('routesDateLabel')) el('routesDateLabel').textContent = currentSelectedDate;

      // check server session
      const meRes = await fetchWithCreds('/me');
      let meJson;
      try { meJson = await meRes.json(); } catch(e){ meJson = { id: null }; }
      if (meJson && meJson.id){
        loggedUser = { name: meJson.name, email: meJson.email || '' };
        el('userName').textContent = meJson.name || '';
        el('authArea').classList.add('hidden');
        el('loggedBlock').classList.remove('hidden');
        if (el('off_join_name')) { el('off_join_name').value = meJson.name || ''; el('off_join_name').readOnly = true; }
        // enable only calendar
        el('tabBtnCalendar').classList.remove('disabled');
        document.querySelector('#mainTabs').classList.remove('nav-locked');
        new bootstrap.Tab(el('tabBtnCalendar')).show();
        el('tab-calendar').classList.remove('hidden');
        el('tab-routes').classList.remove('hidden');
        el('tab-links').classList.remove('hidden');
        loadRoutesForDate(currentSelectedDate);
      }
    } catch(e){ console.error('init error', e); }
  })();

  </script>
</body>
</html>
